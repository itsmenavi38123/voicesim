# voicesimai.yaml
properties:
  configuration:
    activeRevisionsMode: Single
    ingress:
      external: true
      targetPort: 3000 # Publicly expose simstudio
    registries:
      - server: ghcr.io
        username: itsmenavi38123
        passwordSecretRef: reg-pswd-9b9dd5aa-b5d2
    secrets:
      - name: reg-pswd-9b9dd5aa-b5d2
  template:
    containers:
      - name: simstudio
        image: ghcr.io/itsmenavi38123/simstudio:latest
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: DATABASE_URL
            value: "postgresql://voicecakedevelop:Test%401234@voiecakeprelive.postgres.database.azure.com:5432/postgres?sslmode=require"
          - name: BETTER_AUTH_URL
            value: "https://voicesimai.livelysand-bea0689a.canadacentral.azurecontainerapps.io"
          - name: NEXT_PUBLIC_APP_URL
            value: "https://voicesimai.livelysand-bea0689a.canadacentral.azurecontainerapps.io"
          - name: BETTER_AUTH_SECRET
            value: "supersecret123"
          - name: ENCRYPTION_KEY
            value: "your_encryption_key_here"
          - name: GOOGLE_CLIENT_ID
            value: "placeholder"
          - name: GOOGLE_CLIENT_SECRET
            value: "placeholder"
          - name: GITHUB_CLIENT_ID
            value: "placeholder"
          - name: GITHUB_CLIENT_SECRET
            value: "placeholder"
          - name: RESEND_API_KEY
            value: "placeholder"
          - name: OLLAMA_URL
            value: "http://localhost:11434"
          - name: SOCKET_SERVER_URL
            value: "http://realtime:3002"
          - name: NEXT_PUBLIC_SOCKET_URL
            value: "http://realtime:3002"
        probes:
          - httpGet:
              path: "/"
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 90
            successThreshold: 1
            failureThreshold: 3

      - name: realtime
        image: ghcr.io/itsmenavi38123/realtime:latest
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: DATABASE_URL
            value: "postgresql://voicecakedevelop:Test%401234@voiecakeprelive.postgres.database.azure.com:5432/postgres?sslmode=require"
          - name: BETTER_AUTH_URL
            value: "https://voicesimai.livelysand-bea0689a.canadacentral.azurecontainerapps.io"
          - name: NEXT_PUBLIC_APP_URL
            value: "https://voicesimai.livelysand-bea0689a.canadacentral.azurecontainerapps.io"
        probes:
          - httpGet:
              path: "/health"
              port: 3002
            initialDelaySeconds: 10
            periodSeconds: 90
            successThreshold: 1
            failureThreshold: 3

      - name: migrations
        image: ghcr.io/itsmenavi38123/migrations:latest
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: DATABASE_URL
            value: "postgresql://voicecakedevelop:Test%401234@voiecakeprelive.postgres.database.azure.com:5432/postgres?sslmode=require"
        command: ["bunx", "drizzle-kit", "migrate"]

    scale:
      minReplicas: 1
      maxReplicas: 1
      rules: []
